http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    upstream manager-worker {
        server wso-gm-01.koreasouth.cloudapp.azure.com:9443;
    }
     upstream allnodes {
        ip_hash;
        server wso-gw-01.koreasouth.cloudapp.azure.com:9443;
        server wso-gw-02.koreasouth.cloudapp.azure.com:9443;
        server wso-gm-01.koreasouth.cloudapp.azure.com:9443;
    }
    upstream allnodes-traffic-http {
        ip_hash;
        server wso-gw-01.koreasouth.cloudapp.azure.com:8280;
        server wso-gw-02.koreasouth.cloudapp.azure.com:8280;
        server wso-gm-01.koreasouth.cloudapp.azure.com:8280;
    }
    upstream allnodes-traffic-https {
        ip_hash;
        server wso-gw-01.koreasouth.cloudapp.azure.com:8243;
        server wso-gw-02.koreasouth.cloudapp.azure.com:8243;
        server wso-gm-01.koreasouth.cloudapp.azure.com:8243;
    }
    server {
        server_name wso-g-lb.koreasouth.cloudapp.azure.com;
        listen 443;
        ssl on;
        ssl_certificate <<Certifacte.crt>>;
        ssl_certificate_key <<CertficateKey.key>>;
        #Carbon - Manager-worker
        location /carbon {
           index index.html;
           proxy_set_header X-Forwarded-Host $host;
           proxy_set_header X-Forwarded-Server $host;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_pass https://manager-worker/carbon/;
           proxy_redirect  https://manager-worker/carbon/  https://wso-g-lb.koreasouth.cloudapp.azure.com/carbon/;
           #proxy_cookie_path / /carbon/;
       }
        #Store Registry for images - allnodes
        location ~ ^/store/(.*)registry/(.*)$ {
           index index.html;
           proxy_set_header X-Forwarded-Host $host;
           proxy_set_header X-Forwarded-Server $host;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_pass https://allnodes/$1registry/$2;
           proxy_next_upstream     error timeout invalid_header http_500;
            proxy_connect_timeout   2;
        }
        #Publisher Registry for images - manager-worker
       location ~ ^/publisher/(.*)registry/(.*)$ {
           index index.html;
           proxy_set_header X-Forwarded-Host $host;
           proxy_set_header X-Forwarded-Server $host;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_pass https://manager-worker/$1registry/$2;
       }
        # Publisher
        location /publisher {
              index index.html;
               proxy_set_header X-Forwarded-Host $host;
               proxy_set_header X-Forwarded-Server $host;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_pass https://manager-worker/publisher;
               proxy_redirect  https://manager-worker/publisher  https://wso-g-lb.koreasouth.cloudapp.azure.com/publisher;
               proxy_cookie_path /publisher /publisher;
          }
        # Admin Console
        location /admin {
           proxy_set_header X-Forwarded-Host $host;
           proxy_set_header X-Forwarded-Server $host;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_pass https://manager-worker/admin;
           proxy_redirect  https://manager-worker/admin  https://wso-g-lb.koreasouth.cloudapp.azure.com/admin;
           proxy_cookie_path /publisher /publisher;
        } 
        #API traffic - All nodes - HTTPS
        location / {
        proxy_pass https://allnodes-traffic-https/;
        proxy_next_upstream     error timeout invalid_header http_500;
        proxy_connect_timeout   2;
        }
        # All Store - All nodes
        location /store {
           index index.html;
           proxy_set_header X-Forwarded-Host $host;
           proxy_set_header X-Forwarded-Server $host;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_pass https://allnodes/store;
           proxy_redirect https://allnodes/store https://wso-g-lb.koreasouth.cloudapp.azure.com/store;
           proxy_cookie_path /store /store;
           proxy_next_upstream     error timeout invalid_header http_500;
           proxy_connect_timeout   2;
        }
    }
        server {
        server_name  wso-g-lb.koreasouth.cloudapp.azure.com;
        listen 80;
        #API traffic - All nodes - HTTP
        location / {
        proxy_pass http://allnodes-traffic-http/;
        proxy_next_upstream     error timeout invalid_header http_500;
        proxy_connect_timeout   2;
        }
        }
}